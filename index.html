<html>
  <head>
    <title></title>
    <meta charset="utf-8" />
    <style>
      body {
        position: absolute;
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;

        color: white;
        background-color: black;
      }
      .prompt {
        width: 100%;
        border: grey solid 1px;

        color: white;
        background-color: black;
      }
      .disabled {
        border-color: #303030;
        color: grey;
      }
      .output {
      }
    </style>
    <script src="jsh.js"></script>
  </head>
  <body>
    <div id="help" style="display: none;">
      <div>
        <p>This terminal is a simple <span style="color: magenta">Javascript</span> console.</p>
        <p>
          It shows the return value of what you type. It handles special return values like
          <span style="color: green">HTMLElement</span> and <span style="color: green">Promise</span>.
        </p>
        <p>
          The `<code style="color: blue">dir(..)</code>` function shows object properties,
          it is useful to know what kind of object you are manipulating.
          (see `<code style="color: blue">dir(jsh)</code>`.)
        </p>
        <p>Use <span style="color: yellow">Ctrl-ArrowUp</span> or <span style="color: yellow">Ctrl-ArrowDown</span> to browse command history</p>
      </div>
    </div>
    <script>
      var help = document.querySelector("#help").querySelector("div");

      (function () {
        var terminal = document.createElement("div"), history = [];
        document.body.appendChild(terminal);
        jsh.loop(function () {
          var historyIndex = history.length, valueIndex = history.length;
          history[valueIndex] = "";
          return jsh.then(function () {
            var input = document.createElement("textarea");
            input.className = "prompt";
            input.placeholder = "> Type your command here. Type `help` for more information.";
            input.setAttribute("rows", 1);
            setTimeout(function () { input.focus(); });
            terminal.appendChild(input);
            return new Promise(function (done) {
              input.addEventListener("keydown", function f(ev) {
                if (ev.ctrlKey) {
                  if (ev.key === "ArrowUp" || ev.key === "Up" || ev.keyIdentifier === "Up") {
                    if (historyIndex === history.length - 1) {
                      history[valueIndex] = input.value;
                    }
                    if (historyIndex > 0) {
                      historyIndex -= 1;
                      input.value = history[historyIndex];
                    }
                  } else if (ev.key === "ArrowDown" || ev.key === "Down" || ev.keyIdentifier === "Down") {
                    if (historyIndex < history.length - 1) {
                      historyIndex += 1;
                      input.value = history[historyIndex];
                    }
                  }
                }
                if (ev.key === "Enter" || ev.keyIdentifier === "Enter") {
                  if (ev.shiftKey) {
                    input.setAttribute("rows", input.value.split("\n").length + 1);
                  } else {
                    input.setAttribute("rows", input.value.split("\n").length);
                    if (input.value === "") { return ev.preventDefault(); }
                    input.removeEventListener("keydown", f);
                    input.setAttribute("class", input.getAttribute("class") + " disabled");
                    input.disabled = true;
                    done(input.value);
                  }
                }
              });
            });
          }).then(function (inputValue) {
            var output = document.createElement("div"), pre = document.createElement("pre");
            terminal.appendChild(output);
            history[valueIndex] = inputValue;
            return jsh.then(function () {
              return window.eval(inputValue);
            }).then(function (eVal) {
              if (!(eVal instanceof HTMLElement)) {
                pre.textContent = eVal;
                eVal = pre;
              }
              output.appendChild(eVal);
            }).catch(function (e) {
              pre.textContent = e;
              output.appendChild(pre);
            });
          });
        });
      }());

      function dir(obj) {
        var k, s = "";
        for (k in obj) {
          if (k.slice(0, 1) !== "_") {
            s += k + ": " + typeof obj[k] + "\n";
          }
        }
        return s;
      }
    </script>
  </body>
</html>
